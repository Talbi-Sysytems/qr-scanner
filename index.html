<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Code Scanner</title>
  <link rel="stylesheet" href="scanner.css">
  <!-- Include jsQR library -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
</head>
<body>
  <div class="container">
    <h1>QR Code Scanner</h1>
    <canvas id="qr-canvas" width="300" height="300"></canvas>
    <button id="start-btn" onclick="startScanner()">Start Scanning</button>
    <button id="stop-btn" onclick="stopScanner()">Stop Scanning</button>
    <p id="result">Result: </p>
    <p id="status">Status: Waiting for QR code...</p>
  </div>

  <script>
    // Set up canvas and video stream
    let video;
    let canvasElement = document.getElementById("qr-canvas");
    let canvas = canvasElement.getContext("2d");
    let scanning = false;

    // Start QR scanner
    function startScanner() {
      video = document.createElement("video");
      navigator.mediaDevices
        .getUserMedia({ video: { facingMode: "environment" } })
        .then(function (stream) {
          video.srcObject = stream;
          video.setAttribute("playsinline", true); // Required to play video inline on iPhone
          video.play();
          requestAnimationFrame(scanQRCode);
          scanning = true;
        })
        .catch(function (err) {
          console.error("Error accessing the camera:", err);
        });
    }

    // Stop QR scanner
    function stopScanner() {
      if (video && video.srcObject) {
        let stream = video.srcObject;
        let tracks = stream.getTracks();
        tracks.forEach(track => track.stop());
        video.srcObject = null;
        scanning = false;
        document.getElementById("status").innerText = "Scanning stopped.";
      }
    }

    // Scan QR code from video stream
    function scanQRCode() {
      if (scanning) {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvasElement.height = video.videoHeight;
          canvasElement.width = video.videoWidth;
          canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
          let imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
          let code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

          if (code) {
            document.getElementById("status").innerText = "QR Code Scanned!";
            document.getElementById("result").innerText = "Result: " + code.data;

            // Verify if the scanned name exists in the Google Sheets database
            fetch("https://script.google.com/macros/s/AKfycby1D3YWG0_Hl5sjYhV9O3jCwfp4qIk3CLhMaXDx2S6JUf3BHJnzQX3wXLfbhe80Htbryw/exec?name=" + encodeURIComponent(code.data))
              .then(response => response.json())
              .then(data => {
                if (data.result === "success") {
                  document.getElementById("status").innerText = "Name is valid!";
                  document.getElementById("status").style.color = "green";
                } else {
                  document.getElementById("status").innerText = "Name not found.";
                  document.getElementById("status").style.color = "red";
                }
              })
              .catch(error => {
                console.error("Error:", error);
                document.getElementById("status").innerText = "Error verifying name.";
              });
          }
        }
        requestAnimationFrame(scanQRCode);
      }
    }
  </script>
</body>
</html>
